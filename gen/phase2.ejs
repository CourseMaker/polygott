#!/bin/bash
set -ev
shopt -s dotglob

export HOME=/home/runner

<% for ( let lang of languages ) { -%>
<% if ( lang.setup ) { -%>

echo Setup <%= lang.id %>

<% for ( let line of lang.setup ) { -%>
<%- undup(line) %>
<% } -%>

if [ -n "$(ls -A /home/runner)" ]; then
	echo Storing home for <%= lang.id %>
	mkdir -p /opt/homes/<%= lang.id %>
	cp -r /opt/homes/default/* /opt/homes/<%= lang.id %>
	mv -nt /opt/homes/<%= lang.id %>/ /home/runner/*
	ls -A /opt/homes/<%= lang.id %>
fi
<% } -%>
<% } -%>

chown runner:runner -R /opt/homes
cp -r /opt/homes/default/* /home/runner
chown runner:runner -R /home/runner
chown runner:runner -R /config
chown runner:runner -R /opt/virtualenvs

rm -rf /var/lib/apt/lists/*

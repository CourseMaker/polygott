#!/bin/bash
set -ev
shopt -s dotglob

export HOME=/home/runner

<% for ( let lang of languages ) { -%>
<% if ( lang.setup ) { -%>

echo Setup <%= lang.id %>

<% for ( let line of lang.setup ) { -%>
<%- undup(line) %>
<% } -%>

if [ -n "$(ls -A /home/runner)" ]; then
	echo Storing home for <%= lang.id %>
	mkdir -p /opt/homes/<%= lang.id %>
	if compgen -G "/opt/homes/default/*" > /dev/null; then
		cp -r /opt/homes/default/* /opt/homes/<%= lang.id %>
	fi
	mv -nt /opt/homes/<%= lang.id %>/ /home/runner/*
	ls -A /opt/homes/<%= lang.id %>
fi
<% } -%>
<% } -%>
